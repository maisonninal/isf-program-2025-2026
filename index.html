<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Programme ISF Apprentissage 2025/2026 — Mini-site</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#101828;
      --muted:#667085;
      --line:#eaecf0;
      --blue:#0b74ff;
      --blueDark:#0a66df;
      --card:#f9fafb;
      --mark:#ffe58f;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text); background:var(--bg); }
    header{
      padding:18px 18px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(255,255,255,.92); backdrop-filter:saturate(180%) blur(6px);
      z-index:10;
    }
    h1{ margin:0 0 10px; font-size:24px; font-weight:750; }
    .searchRow{ display:flex; gap:10px; align-items:center; }
    input[type="search"]{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:6px;
      outline:none;
      font-size:14px;
    }
    input[type="search"]:focus{ border-color:var(--blue); box-shadow:0 0 0 3px rgba(11,116,255,.15); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .chip.active{ border-color:var(--blue); color:var(--text); }

    .layout{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:18px;
      padding:16px 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .sectionTitle{
      margin:18px 0 10px;
      font-size:16px;
      font-weight:750;
      text-align:center;
      color:#111827;
    }
    .divider{
      height:1px; background:var(--line); margin:10px 0 16px;
    }

    details.course{
      border:1px solid var(--line);
      border-radius:4px;
      overflow:hidden;
      margin:10px 0;
      background:#fff;
    }
    summary.courseHead{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      background:linear-gradient(0deg,var(--blueDark),var(--blue));
      color:#fff;
      font-weight:700;
      font-size:14px;
    }
    summary.courseHead::-webkit-details-marker{ display:none; }
    .courseBody{
      padding:12px;
      background:#fff;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 760px){
      .grid2{ grid-template-columns:1fr; }
    }
    .box{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:8px;
      padding:10px 12px;
    }
    .box h3{ margin:0 0 8px; font-size:13px; }
    .box p, .box li{ margin:0; color:var(--muted); font-size:13px; line-height:1.45; }
    ul{ margin:0; padding-left:18px; }
    .metaLine{ color:rgba(255,255,255,.9); font-weight:600; }
    mark{ background:var(--mark); padding:0 3px; border-radius:4px; }

    .panel{
      position:sticky; top:88px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px;
      background:#fff;
    }
    .panel h2{ margin:0 0 8px; font-size:14px; }
    .panel .small{ color:var(--muted); font-size:12px; line-height:1.45; }
    .resultCard{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      margin-top:10px;
      background:var(--card);
      cursor:pointer;
    }
    .resultCard b{ font-size:13px; }
    .resultCard .small{ margin-top:4px; }
    .count{ color:var(--muted); font-size:12px; margin-top:10px; }
    .error{
      border:1px solid #fda29b;
      background:#fffbfa;
      color:#b42318;
      padding:10px;
      border-radius:10px;
      margin-top:10px;
      font-size:13px;
      line-height:1.45;
    }
  </style>
</head>

<body>
<header>
  <h1>Programme ISF Apprentissage 2025/2026</h1>
  <div class="searchRow">
    <input id="q" type="search" placeholder="Tapez un mot pour rechercher…" />
  </div>
  <div class="chips" id="chips"></div>
</header>

<div class="layout">
  <main id="list"></main>

  <aside class="panel">
    <h2>Résultats instantanés</h2>
    <div class="small">Tapez un mot-clé. Cliquez un résultat pour ouvrir le module correspondant. Les occurrences sont surlignées.</div>
    <div class="count" id="count"></div>
    <div id="results"></div>
  </aside>
</div>

<script>
  // ==========================
  // 0) State
  // ==========================
  let COURSES = [];
  let GROUPS = [];
  let activeGroup = "Tous";

  const q = document.getElementById("q");
  const list = document.getElementById("list");
  const results = document.getElementById("results");
  const count = document.getElementById("count");
  const chips = document.getElementById("chips");

  // ==========================
  // 1) Load data.json (YOU HAVE THIS)
  // ==========================
  async function loadCourses() {
    try {
      const res = await fetch("./data.json");
      if (!res.ok) throw new Error("Fetch failed: " + res.status);

      const raw = await res.json();

      // Map your extracted fields (from Colab script) -> fields used by this UI
      COURSES = raw.map(c => ({
        id: c.id,
        group: (c.group && c.group.trim()) ? c.group.trim() : "Tronc Commun", // default
        semester: c.semester || "",
        title: c.title || "",
        hours: (c.hours === null || c.hours === undefined) ? null : c.hours,
        teacher: c.teacher || "",
        org: c.org || "",

        // In extracted json we have "description_raw" (string). Turn into list.
        content: splitLines(c.description_raw),

        prereq: {
          recommended: c.prereq_recommended || "",
          mandatory: c.prereq_mandatory || ""
        },
        skills: c.skills || "",
        assessment: c.assessment || "",

        // Later you'll fill keywords; keep empty for now.
        keywords: Array.isArray(c.keywords) ? c.keywords : []
      }));

      GROUPS = [...new Set(COURSES.map(c => c.group))];

      renderChips();
      renderResults();
    } catch (e) {
      results.innerHTML = `<div class="error">
        <b>Impossible de charger data.json</b><br/>
        Vérifie que :<br/>
        • index.html et data.json sont dans le même dossier<br/>
        • tu ouvres via un serveur (Live Server / http://localhost...), pas en double-cliquant (file://)<br/>
        <br/>Erreur: ${escapeHtml(String(e))}
      </div>`;
      count.textContent = "";
      list.innerHTML = "";
    }
  }

  function splitLines(raw) {
    if (!raw) return [];
    return String(raw)
      .split("\n")
      .map(x => x.trim())
      .filter(Boolean)
      .map(x => x.replace(/^\d+[\.\)]\s*/, "")); // remove "1. "
  }

  // ==========================
  // 2) Helpers
  // ==========================
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function highlight(text, query){
    if(!query) return escapeHtml(text);
    const safe = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp(`(${safe})`, "ig");
    return escapeHtml(text).replace(re, "<mark>$1</mark>");
  }
  function haystack(course){
    return [
      course.group, course.semester, course.title, course.teacher, course.org,
      ...(course.content||[]),
      course.prereq?.recommended||"", course.prereq?.mandatory||"",
      course.skills||"", course.assessment||"",
      ...(course.keywords||[])
    ].join(" ").toLowerCase();
  }

  // ==========================
  // 3) Render list (accordion)
  // ==========================
  function renderList(query=""){
    const grouped = new Map();
    for(const g of GROUPS){ grouped.set(g, []); }
    for(const c of COURSES){
      if(!grouped.has(c.group)) grouped.set(c.group, []);
      grouped.get(c.group).push(c);
    }

    list.innerHTML = "";
    for(const g of GROUPS){
      if(activeGroup !== "Tous" && activeGroup !== g) continue;

      const h = document.createElement("div");
      h.className = "sectionTitle";
      h.textContent = g;
      list.appendChild(h);

      const div = document.createElement("div");
      div.className = "divider";
      list.appendChild(div);

      for(const c of grouped.get(g) || []){
        const details = document.createElement("details");
        details.className = "course";
        details.id = c.id;

        const summary = document.createElement("summary");
        summary.className = "courseHead";
        summary.innerHTML = `
          <span class="metaLine">
            ${escapeHtml(c.semester)}: ${highlight(c.title, query)}
            ${c.hours ? `(${escapeHtml(c.hours)}h)` : ""}
            ${c.teacher ? ` - ${escapeHtml(c.teacher)}` : ""}
            ${c.org ? ` (${escapeHtml(c.org)})` : ""}
          </span>
        `;

        const body = document.createElement("div");
        body.className = "courseBody";
        body.innerHTML = `
          <div class="grid2">
            <div class="box">
              <h3>Description du contenu de l'enseignement :</h3>
              <ul>
                ${(c.content||[]).map(x=>`<li>${highlight(x, query)}</li>`).join("")}
              </ul>
            </div>
            <div class="box">
              <h3>Mode de contrôle des connaissances :</h3>
              <p>${highlight(c.assessment||"", query)}</p>
              <div style="height:10px"></div>
              <h3>Compétences à acquérir :</h3>
              <p>${highlight(c.skills||"", query)}</p>
            </div>
            <div class="box">
              <h3>Pré-requis recommandés :</h3>
              <p>${highlight(c.prereq?.recommended||"", query)}</p>
            </div>
            <div class="box">
              <h3>Pré-requis obligatoires :</h3>
              <p>${highlight(c.prereq?.mandatory||"", query)}</p>
            </div>
            <div class="box" style="grid-column:1/-1;">
              <h3>Mots-clés (index) :</h3>
              <p>${
                (c.keywords||[]).length
                  ? (c.keywords||[]).slice(0,24).map(k=>`<span class="chip" style="cursor:default;">${highlight(k, query)}</span>`).join(" ")
                  : `<span class="chip" style="cursor:default; opacity:.7;">(à compléter)</span>`
              }</p>
            </div>
          </div>
        `;
        details.appendChild(summary);
        details.appendChild(body);
        list.appendChild(details);
      }
    }
  }

  // ==========================
  // 4) Right instant results
  // ==========================
  function renderResults(){
    const query = q.value.trim();
    const qLower = query.toLowerCase();

    const filtered = COURSES.filter(c => {
      if(activeGroup !== "Tous" && c.group !== activeGroup) return false;
      if(!query) return true;
      return haystack(c).includes(qLower);
    });

    count.textContent = query ? `${filtered.length} module(s) lié(s) à “${query}”` : `${filtered.length} module(s)`;
    results.innerHTML = filtered.slice(0,40).map(c => `
      <div class="resultCard" data-id="${escapeHtml(c.id)}">
        <b>${escapeHtml(c.semester)} · ${highlight(c.title, query)}</b>
        <div class="small">${escapeHtml(c.group)}${c.teacher ? ` — ${escapeHtml(c.teacher)}` : ""}${c.org ? ` (${escapeHtml(c.org)})` : ""}</div>
      </div>
    `).join("");

    results.querySelectorAll(".resultCard").forEach(el=>{
      el.onclick = () => {
        const id = el.getAttribute("data-id");
        const det = document.getElementById(id);
        if(det){
          det.open = true;
          det.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      };
    });

    renderList(query);
  }

  // ==========================
  // 5) Chips (group filter)
  // ==========================
  function renderChips(){
    const labels = ["Tous", ...GROUPS];
    chips.innerHTML = labels.map(l => `
      <div class="chip ${l===activeGroup?"active":""}" data-g="${escapeHtml(l)}">${escapeHtml(l)}</div>
    `).join("");
    chips.querySelectorAll(".chip").forEach(ch=>{
      ch.onclick = () => {
        activeGroup = ch.getAttribute("data-g");
        renderChips();
        renderResults();
      };
    });
  }

  // Debounce instant search
  let t=null;
  q.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(renderResults, 80);
  });

  // ==========================
  // 6) Start
  // ==========================
  loadCourses();
</script>
</body>
</html>
